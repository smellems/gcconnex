DROP PROCEDURE IF EXISTS GET_suggestedFriends;
CREATE PROCEDURE `GET_suggestedFriends`(IN `UserGUID` BIGINT(20),IN Sug_Limit INT) BEGIN select fof.guid_two,ue.username FROM prefix_entities as e INNER JOIN prefix_users_entity ue ON ue.guid = e.guid INNER JOIN prefix_entity_relationships fr ON fr.guid_one = UserGUID AND fr.relationship = 'friend' INNER JOIN prefix_entity_relationships fof ON fof.guid_one = fr.guid_two AND fof.relationship = 'friend' WHERE ue.banned='no' and e.guid NOT IN (SELECT f.guid_two FROM prefix_entity_relationships f WHERE f.guid_one = UserGUID AND f.relationship = 'friend') and fof.guid_two = e.guid and e.guid != UserGUID GROUP BY e.guid ORDER BY fof.guid_two desc, ue.last_action DESC LIMIT Sug_Limit;END;